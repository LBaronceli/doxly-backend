name: doxly
services:
  postgres:
    image: postgres:16
    env_file: ./env/postgres.env
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    ports: ["6379:6379"]
    volumes:
      - redisdata:/data

  minio:
    image: minio/minio:latest
    env_file: ./env/minio.env
    command: server /data --console-address ":9001"
    ports: ["9000:9000", "9001:9001"]
    volumes: ["minio:/data"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # one-shot init to create the doxly bucket
  minio-setup:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD &&
      /usr/bin/mc mb -p local/doxly || true &&
      /usr/bin/mc anonymous set download local/doxly || true
      "
    env_file: ./env/minio.env

  auth:
    build:
      context: ../../
      dockerfile: services/auth-service/Dockerfile
    env_file: ./env/auth.env
    depends_on: [postgres]
    ports: ["8081:8080"]

  customer:
    build:
      context: ../../
      dockerfile: services/customer-api/Dockerfile
    env_file: ./env/customer.env
    depends_on: [postgres, auth]
    ports: ["8082:8080"]

  attachments:
    build:
      context: ../../
      dockerfile: services/attachments-service/Dockerfile
    env_file: ./env/attachments.env
    depends_on: [minio, minio-setup, auth, customer]
    ports: ["8083:8080"]

volumes:
  pgdata: {}
  redisdata: {}
  minio: {}
